@using System
@using System.Net
@using System.Net.Http
@using System.Net.Http.Json
@using LibraryManagement.Api.Rest.Client
@using LibraryManagement.Api.Rest.Client.Domain.Authors
@using LibraryManagement.Api.Rest.Client.Domain.Authors.Create
@using LibraryManagement.Web.Components.Pages
@using LibraryManagement.Web.Domain.Authors.CreateAuthor

@inherits TestContext

@code {
    [Fact]
    public void Author_page_submits_create_request_and_displays_created_author()
    {
        AuthorDto response = new() { Id = "author-42", Name = "Ada Lovelace" };
        RegisterRestClient(response);

        var cut = Render(@<CreateAuthorPage />);
        cut.Find("#author-name").Change("Ada Lovelace");
        cut.Find(".create-author-btn").Click();

        cut.WaitForState(() => cut.FindAll(".created-author").Count == 1);

        Assert.Contains("Ada Lovelace", cut.Find(".created-author").TextContent);
    }

    private void RegisterRestClient(AuthorDto response)
    {
        Services.AddScoped<IRestAPiClient>(_ =>
        {
            var handler = new StubHttpMessageHandler(response);
            return new RestApiClient(new HttpClient(handler)
            {
                BaseAddress = new Uri("http://localhost")
            });
        });
    }

    private sealed class StubHttpMessageHandler : HttpMessageHandler
    {
        private readonly AuthorDto _response;

        public StubHttpMessageHandler(AuthorDto response)
        {
            _response = response;
        }

        protected override Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
        {
            if (request.Method == HttpMethod.Post && request.RequestUri?.AbsolutePath == "/api/v1/authors")
            {
                return Task.FromResult(new HttpResponseMessage(HttpStatusCode.OK)
                {
                    Content = JsonContent.Create(_response)
                });
            }

            return Task.FromResult(new HttpResponseMessage(HttpStatusCode.NotFound));
        }
    }
}
