@using System.Net
@using System.Net.Http.Json
@using LibraryManagement.Api.Rest.Client
@using LibraryManagement.Api.Rest.Client.Domain.Books
@using LibraryManagement.Api.Rest.Client.Domain.Books.Search
@using LibraryManagement.Web.Domain.Books.ListBooks
@inherits TestContext

@code {

    [Fact]
    public void Book_page_displays_books_returned_by_search_endpoint_impl()
    {
        var expectedBooks = new[]
        {
            new BookDto { Id = "1", Title = "Clean Code", AuthorId = "author-1", Description = "Code craftsmanship", Keywords = new[] { "clean-code", "craftsmanship" } },
            new BookDto { Id = "2", Title = "Domain-Driven Design", AuthorId = "author-2", Description = "DDD guide", Keywords = new[] { "ddd" } }
        };
        RegisterRestClient(new SearchBooksResponseDto(expectedBooks));

        var cut = Render(@<ListBooks/>);
        cut.WaitForState(() => cut.FindAll(".book-item").Count == expectedBooks.Length);

        var renderedTitles = cut.FindAll("h4").Select(h => h.TextContent.Trim()).ToArray();
        Assert.Equal(expectedBooks.Select(book => book.Title), renderedTitles);

        var renderedDescriptions = cut.FindAll(".book-description").Select(p => p.TextContent.Trim()).ToArray();
        Assert.Equal(expectedBooks.Select(book => book.Description), renderedDescriptions);

        var renderedAuthors = cut.FindAll(".book-author").Select(p => p.TextContent.Trim()).ToArray();
        Assert.Equal(expectedBooks.Select(book => $"Author: {book.AuthorId}"), renderedAuthors);

        var renderedKeywords = cut.FindAll(".book-keywords").Select(p => p.TextContent.Trim()).ToArray();
        Assert.Equal(expectedBooks.Select(book => $"Keywords: {string.Join(", ", book.Keywords)}"), renderedKeywords);
    }

    private void RegisterRestClient(SearchBooksResponseDto response)
    {
        Services.AddScoped<IRestAPiClient>(_ =>
        {
            var handler = new StubHttpMessageHandler(response);
            return new RestApiClient(new HttpClient(handler)
            {
                BaseAddress = new Uri("http://localhost")
            });
        });
    }

    private sealed class StubHttpMessageHandler : HttpMessageHandler
    {
        private readonly SearchBooksResponseDto _response;

        public StubHttpMessageHandler(SearchBooksResponseDto response)
        {
            _response = response;
        }

        protected override Task<HttpResponseMessage> SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
        {
            if (request.Method == HttpMethod.Post && request.RequestUri is { AbsolutePath: "/v1/books/search" or "/api/v1/books/search" })
            {
                return Task.FromResult(new HttpResponseMessage(HttpStatusCode.OK)
                {
                    Content = JsonContent.Create(_response)
                });
            }

            return Task.FromResult(new HttpResponseMessage(HttpStatusCode.NotFound));
        }
    }

}
